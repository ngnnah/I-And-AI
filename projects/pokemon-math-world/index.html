<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#6366F1">
  <title>Pokemon Math World</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@600;700;800&display=swap');

    :root {
      --vh: 1vh;
      --primary: #6366F1;
      --primary-dark: #4F46E5;
      --success: #10B981;
      --success-dark: #059669;
      --warning: #F59E0B;
      --danger: #EF4444;
      --pokemon-yellow: #FFCB05;
      --pokemon-blue: #3D7DCA;
      --champion-gold: #FFD700;
      --champion-purple: #9333EA;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      min-height: calc(var(--vh, 1vh) * 100);
      padding: max(10px, env(safe-area-inset-top)) max(10px, env(safe-area-inset-right)) max(10px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 15px;
    }

    .btn {
      font-family: 'Fredoka One', cursive;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.1s;
      touch-action: manipulation;
    }

    .btn:active {
      transform: translateY(3px);
    }

    .btn-primary {
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 5px 0 #3730A3;
    }

    .btn-success {
      background: linear-gradient(180deg, var(--success) 0%, var(--success-dark) 100%);
      color: white;
      box-shadow: 0 5px 0 #047857;
    }

    .btn-warning {
      background: linear-gradient(180deg, var(--pokemon-yellow) 0%, #E5B800 100%);
      color: #1F2937;
      box-shadow: 0 5px 0 #B8860B;
    }

    .btn-champion {
      background: linear-gradient(180deg, var(--champion-gold) 0%, #FFA500 100%);
      color: #1F2937;
      box-shadow: 0 5px 0 #B8860B;
    }

    /* === WORLD SELECT SCREEN === */
    .world-select {
      text-align: center;
      padding: 15px;
    }

    .world-logo {
      font-family: 'Fredoka One', cursive;
      font-size: clamp(1.8rem, 7vw, 2.8rem);
      color: var(--pokemon-yellow);
      text-shadow: 3px 3px 0 var(--pokemon-blue), -1px -1px 0 var(--pokemon-blue), 1px -1px 0 var(--pokemon-blue), -1px 1px 0 var(--pokemon-blue);
      margin-bottom: 10px;
    }

    .world-subtitle {
      color: white;
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .level-cards {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .level-card {
      background: white;
      border-radius: 20px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      border: 4px solid transparent;
      text-align: left;
      position: relative;
      overflow: hidden;
    }

    .level-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }

    .level-card:active {
      transform: scale(0.98);
    }

    .level-card.trainer-school {
      border-color: #22C55E;
      background: linear-gradient(135deg, #DCFCE7 0%, white 30%);
    }

    .level-card.pokemon-league {
      border-color: #6366F1;
      background: linear-gradient(135deg, #E0E7FF 0%, white 30%);
    }

    .level-card.champions-road {
      border-color: var(--champion-gold);
      background: linear-gradient(135deg, #FEF3C7 0%, white 30%);
    }

    .level-card.locked {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .level-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .level-icon {
      font-size: 2.5rem;
    }

    .level-title {
      font-family: 'Fredoka One', cursive;
      font-size: 1.3rem;
      color: #1F2937;
    }

    .level-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 10px;
      font-weight: 700;
    }

    .badge-easy { background: #DCFCE7; color: #166534; }
    .badge-medium { background: #E0E7FF; color: #3730A3; }
    .badge-hard { background: #FEF3C7; color: #92400E; }

    .level-desc {
      color: #6B7280;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .level-features {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .feature-tag {
      background: #F3F4F6;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.75rem;
      color: #374151;
      font-weight: 600;
    }

    .level-progress {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #E5E7EB;
      font-size: 0.85rem;
      color: #6B7280;
    }

    .level-progress .stars {
      color: var(--pokemon-yellow);
    }

    /* === SHARED GAME STYLES === */
    .logo {
      font-family: 'Fredoka One', cursive;
      font-size: clamp(1.6rem, 6vw, 2.2rem);
      color: var(--pokemon-yellow);
      text-shadow: 3px 3px 0 var(--pokemon-blue), -1px -1px 0 var(--pokemon-blue), 1px -1px 0 var(--pokemon-blue), -1px 1px 0 var(--pokemon-blue);
      margin-bottom: 5px;
    }

    .subtitle {
      color: white;
      font-size: 0.95rem;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .start-screen {
      text-align: center;
      padding: 15px;
    }

    .name-input-section {
      margin-bottom: 15px;
    }

    .name-input-section label {
      display: block;
      color: #374151;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .name-input {
      width: 100%;
      padding: 12px 15px;
      font-size: 1.1rem;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      border: 3px solid #E5E7EB;
      border-radius: 12px;
      text-align: center;
      transition: border-color 0.2s;
    }

    .name-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .trainer-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 15px 0;
    }

    .trainer-card {
      background: white;
      padding: 10px 5px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 4px solid transparent;
      text-align: center;
    }

    .trainer-card.selected {
      border-color: var(--pokemon-yellow);
      background: #FFFBEB;
      box-shadow: 0 0 15px rgba(255, 203, 5, 0.4);
    }

    .trainer-card:active {
      transform: scale(0.95);
    }

    .trainer-card img {
      width: 64px;
      height: 64px;
      image-rendering: pixelated;
    }

    .trainer-card .name {
      font-weight: 700;
      font-size: 0.75rem;
      color: #374151;
      margin-top: 5px;
    }

    .starter-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .starter-card {
      background: white;
      padding: 12px 8px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.2s;
      border: 4px solid transparent;
      text-align: center;
    }

    .starter-card.selected {
      border-color: var(--primary);
      background: #EEF2FF;
    }

    .starter-card:active {
      transform: scale(0.95);
    }

    .starter-card img {
      width: 70px;
      height: 70px;
      image-rendering: pixelated;
    }

    .starter-card .name {
      font-weight: 700;
      color: #374151;
      font-size: 0.85rem;
    }

    .type-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 10px;
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      margin-top: 5px;
    }

    .start-btn {
      font-size: 1.4rem;
      padding: 15px 40px;
      margin-top: 15px;
    }

    .stats-preview {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin-top: 15px;
      color: white;
    }

    .stat-preview {
      text-align: center;
    }

    .stat-preview .value {
      font-family: 'Fredoka One', cursive;
      font-size: 1.3rem;
    }

    .stat-preview .label {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    /* Game Header */
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 10px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .trainer-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #F3F4F6;
      overflow: hidden;
    }

    .trainer-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .player-info .player-name {
      font-weight: 700;
      color: #1F2937;
      font-size: 0.9rem;
    }

    .player-info .badges {
      font-size: 0.85rem;
    }

    .header-stats {
      display: flex;
      gap: 15px;
    }

    .stat {
      text-align: center;
    }

    .stat-icon {
      font-size: 1.2rem;
    }

    .stat-value {
      font-family: 'Fredoka One', cursive;
      font-size: 1rem;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.6rem;
      color: #6B7280;
      text-transform: uppercase;
    }

    /* Chapter/Battle Area */
    .chapter-screen {
      padding: 15px;
    }

    .chapter-banner {
      text-align: center;
      padding: 25px 20px;
      border-radius: 20px;
      margin-bottom: 15px;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .chapter-banner::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.3) 100%);
    }

    .chapter-banner > * {
      position: relative;
      z-index: 1;
    }

    .env-route { background: linear-gradient(135deg, #22C55E 0%, #15803D 100%); }
    .env-gym { background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); }
    .env-cave { background: linear-gradient(135deg, #78716C 0%, #57534E 100%); }
    .env-water { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); }
    .env-electric { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
    .env-elite { background: linear-gradient(135deg, #9333EA 0%, #6B21A8 100%); }
    .env-champion { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }

    .chapter-title {
      font-family: 'Fredoka One', cursive;
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .chapter-desc {
      font-size: 0.95rem;
      opacity: 0.9;
    }

    .battle-area {
      background: linear-gradient(180deg, #B8E0FF 0%, #90EE90 70%, #228B22 100%);
      border-radius: 25px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.1), 0 8px 20px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
    }

    .battle-area::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: repeating-linear-gradient(90deg, #228B22 0px, #228B22 20px, #32CD32 20px, #32CD32 40px);
      border-radius: 0 0 25px 25px;
    }

    .pokemon-display {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      position: relative;
      z-index: 1;
    }

    .wild-pokemon {
      text-align: center;
    }

    .wild-pokemon img {
      width: 150px;
      height: 150px;
      animation: wildAppear 0.5s ease-out, float 2s ease-in-out infinite;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
      image-rendering: pixelated;
    }

    @keyframes wildAppear {
      from { opacity: 0; transform: scale(0.5) translateY(50px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .pokemon-name {
      font-family: 'Fredoka One', cursive;
      font-size: 1.3rem;
      color: #1F2937;
      background: white;
      padding: 8px 20px;
      border-radius: 20px;
      display: inline-block;
      margin-top: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .hp-bar {
      background: #E5E7EB;
      height: 12px;
      border-radius: 6px;
      margin: 10px auto;
      max-width: 200px;
      overflow: hidden;
    }

    .hp-fill {
      background: linear-gradient(90deg, var(--success) 0%, #34D399 100%);
      height: 100%;
      transition: width 0.3s ease;
    }

    .hp-fill.low { background: linear-gradient(90deg, var(--danger) 0%, #F87171 100%); }
    .hp-fill.medium { background: linear-gradient(90deg, var(--warning) 0%, #FBBF24 100%); }

    /* Question Area */
    .question-area {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .question-prompt {
      text-align: center;
      font-size: 0.9rem;
      color: #6B7280;
      margin-bottom: 10px;
    }

    .question {
      font-family: 'Fredoka One', cursive;
      font-size: clamp(1.8rem, 8vw, 3rem);
      text-align: center;
      color: #1F2937;
      margin: 15px 0;
      padding: 15px;
      background: linear-gradient(180deg, #F3F4F6 0%, #E5E7EB 100%);
      border-radius: 15px;
    }

    .word-problem {
      font-family: 'Nunito', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      line-height: 1.6;
      text-align: center;
      color: #374151;
      margin: 15px 0;
      padding: 20px;
      background: linear-gradient(180deg, #FEF3C7 0%, #FDE68A 100%);
      border-radius: 15px;
      border-left: 5px solid var(--warning);
    }

    .answers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 15px;
    }

    .answers.three-cols {
      grid-template-columns: repeat(3, 1fr);
    }

    .answer-btn {
      font-family: 'Fredoka One', cursive;
      font-size: 1.8rem;
      padding: 20px 15px;
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
      border: none;
      border-radius: 15px;
      color: white;
      cursor: pointer;
      box-shadow: 0 5px 0 #3730A3, 0 8px 15px rgba(0,0,0,0.2);
      transition: all 0.1s;
      touch-action: manipulation;
      min-height: 70px;
    }

    .answer-btn:active {
      transform: translateY(3px);
      box-shadow: 0 2px 0 #3730A3;
    }

    .answer-btn.correct {
      background: linear-gradient(180deg, var(--success) 0%, var(--success-dark) 100%);
      box-shadow: 0 5px 0 #047857;
      animation: correctPulse 0.5s ease;
    }

    .answer-btn.wrong {
      background: linear-gradient(180deg, var(--danger) 0%, #DC2626 100%);
      box-shadow: 0 5px 0 #B91C1C;
      animation: shake 0.5s ease;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .message {
      text-align: center;
      font-family: 'Fredoka One', cursive;
      font-size: 1.1rem;
      padding: 12px;
      margin-top: 12px;
      border-radius: 12px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .message.success {
      background: linear-gradient(180deg, #DCFCE7 0%, #BBF7D0 100%);
      color: var(--success-dark);
    }

    .message.encouragement {
      background: linear-gradient(180deg, #FEF3C7 0%, #FDE68A 100%);
      color: #92400E;
    }

    /* Catch/Victory Screens */
    .catch-screen, .victory-screen {
      text-align: center;
      padding: 20px;
    }

    .catch-animation {
      position: relative;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pokeball {
      width: 80px;
      height: 80px;
      animation: pokeballShake 0.5s ease-in-out 3, pokeballSuccess 0.5s ease 1.5s forwards;
    }

    @keyframes pokeballShake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-20deg); }
      75% { transform: rotate(20deg); }
    }

    @keyframes pokeballSuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .caught-pokemon {
      display: none;
      animation: caughtAppear 0.5s ease;
    }

    .caught-pokemon.show {
      display: block;
    }

    .caught-pokemon img {
      width: 150px;
      height: 150px;
      animation: celebrateBounce 0.5s ease infinite;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));
    }

    @keyframes caughtAppear {
      from { opacity: 0; transform: scale(0) rotate(-180deg); }
      to { opacity: 1; transform: scale(1) rotate(0deg); }
    }

    @keyframes celebrateBounce {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      50% { transform: translateY(-15px) rotate(5deg); }
    }

    .catch-message {
      font-family: 'Fredoka One', cursive;
      font-size: 1.6rem;
      color: var(--pokemon-yellow);
      text-shadow: 2px 2px 0 var(--pokemon-blue), -1px -1px 0 var(--pokemon-blue);
      margin: 15px 0;
    }

    .continue-btn {
      font-size: 1.3rem;
      padding: 15px 35px;
      width: 100%;
      margin-top: 15px;
    }

    .back-btn {
      font-size: 1rem;
      padding: 10px 20px;
      margin-top: 10px;
      background: #6B7280;
      color: white;
      box-shadow: 0 4px 0 #4B5563;
    }

    /* Victory Screen */
    .victory-title {
      font-family: 'Fredoka One', cursive;
      font-size: 2rem;
      color: var(--pokemon-yellow);
      text-shadow: 3px 3px 0 var(--pokemon-blue);
      margin-bottom: 15px;
    }

    .badge-earned {
      font-size: 4rem;
      margin: 15px 0;
      animation: badgeBounce 1s ease infinite;
    }

    @keyframes badgeBounce {
      0%, 100% { transform: scale(1) rotate(-5deg); }
      50% { transform: scale(1.1) rotate(5deg); }
    }

    .victory-stats {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 15px;
      margin: 15px 0;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #E5E7EB;
      font-weight: 600;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    /* Responsive */
    @media (max-width: 400px) {
      .trainer-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .answer-btn {
        font-size: 1.5rem;
        padding: 15px 10px;
        min-height: 60px;
      }
      .header-stats {
        gap: 10px;
      }
    }

    .hidden {
      display: none !important;
    }

    /* Confetti */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      top: -10px;
      animation: confettiFall 3s linear forwards;
      z-index: 1000;
      pointer-events: none;
    }

    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- WORLD SELECT SCREEN -->
    <div class="screen active" id="worldSelectScreen">
      <div class="world-select">
        <div class="world-logo">Pokemon Math World</div>
        <div class="world-subtitle">Choose your adventure!</div>

        <div class="level-cards">
          <div class="level-card trainer-school" onclick="selectLevel('trainer-school')">
            <div class="level-badge badge-easy">Beginner</div>
            <div class="level-header">
              <span class="level-icon">üéí</span>
              <span class="level-title">Trainer School</span>
            </div>
            <div class="level-desc">Start your Pokemon journey! Simple addition problems to catch your first Pokemon.</div>
            <div class="level-features">
              <span class="feature-tag">Addition 0-10</span>
              <span class="feature-tag">2 Choices</span>
              <span class="feature-tag">15 Pokemon</span>
            </div>
            <div class="level-progress" id="trainerSchoolProgress"></div>
          </div>

          <div class="level-card pokemon-league" onclick="selectLevel('pokemon-league')">
            <div class="level-badge badge-medium">Adventure</div>
            <div class="level-header">
              <span class="level-icon">üèÜ</span>
              <span class="level-title">Pokemon League</span>
            </div>
            <div class="level-desc">9 chapters with gym battles! Addition, subtraction, and missing numbers.</div>
            <div class="level-features">
              <span class="feature-tag">Add/Sub 0-25</span>
              <span class="feature-tag">3 Gym Battles</span>
              <span class="feature-tag">25+ Pokemon</span>
            </div>
            <div class="level-progress" id="pokemonLeagueProgress"></div>
          </div>

          <div class="level-card champions-road" onclick="selectLevel('champions-road')">
            <div class="level-badge badge-hard">Challenge</div>
            <div class="level-header">
              <span class="level-icon">üëë</span>
              <span class="level-title">Champion's Road</span>
            </div>
            <div class="level-desc">The ultimate challenge! Multiplication, division, and word problems await!</div>
            <div class="level-features">
              <span class="feature-tag">Add/Sub to 100</span>
              <span class="feature-tag">Multiply/Divide</span>
              <span class="feature-tag">Word Problems</span>
              <span class="feature-tag">Legendary Pokemon</span>
            </div>
            <div class="level-progress" id="championsRoadProgress"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME SCREENS (dynamically populated) -->
    <div class="screen" id="setupScreen"></div>
    <div class="screen" id="chapterScreen"></div>
    <div class="screen" id="gameScreen"></div>
    <div class="screen" id="catchScreen"></div>
    <div class="screen" id="victoryScreen"></div>
  </div>

  <script>
    // ============================================
    // GAME DATA
    // ============================================

    const TRAINERS = {
      ash: { name: 'Ash', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/ash.png' },
      red: { name: 'Red', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/red.png' },
      blue: { name: 'Blue', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/blue.png' },
      green: { name: 'Green', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/green.png' },
      ethan: { name: 'Ethan', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/ethan.png' },
      lyra: { name: 'Lyra', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/lyra.png' },
      brendan: { name: 'Brendan', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/brendan.png' },
      may: { name: 'May', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/may.png' }
    };

    const GYM_LEADERS = {
      brock: { name: 'Brock', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/brock.png' },
      misty: { name: 'Misty', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/misty.png' },
      surge: { name: 'Lt. Surge', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/ltsurge.png' },
      lorelei: { name: 'Lorelei', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/lorelei.png' },
      bruno: { name: 'Bruno', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/bruno.png' },
      lance: { name: 'Lance', sprite: 'https://play.pokemonshowdown.com/sprites/trainers/lance.png' }
    };

    const POKEMON = {
      // Starters
      bulbasaur: { id: 1, name: 'Bulbasaur', type: 'grass', hp: 45, atk: 8 },
      charmander: { id: 4, name: 'Charmander', type: 'fire', hp: 39, atk: 9 },
      squirtle: { id: 7, name: 'Squirtle', type: 'water', hp: 44, atk: 8 },
      // Common
      pikachu: { id: 25, name: 'Pikachu', type: 'electric', hp: 35, atk: 10 },
      rattata: { id: 19, name: 'Rattata', type: 'normal', hp: 30, atk: 6 },
      pidgey: { id: 16, name: 'Pidgey', type: 'flying', hp: 35, atk: 6 },
      caterpie: { id: 10, name: 'Caterpie', type: 'bug', hp: 30, atk: 5 },
      weedle: { id: 13, name: 'Weedle', type: 'bug', hp: 30, atk: 5 },
      oddish: { id: 43, name: 'Oddish', type: 'grass', hp: 40, atk: 7 },
      meowth: { id: 52, name: 'Meowth', type: 'normal', hp: 38, atk: 8 },
      psyduck: { id: 54, name: 'Psyduck', type: 'water', hp: 45, atk: 8 },
      geodude: { id: 74, name: 'Geodude', type: 'rock', hp: 40, atk: 10 },
      zubat: { id: 41, name: 'Zubat', type: 'flying', hp: 35, atk: 7 },
      machop: { id: 66, name: 'Machop', type: 'fighting', hp: 45, atk: 11 },
      eevee: { id: 133, name: 'Eevee', type: 'normal', hp: 50, atk: 9 },
      jigglypuff: { id: 39, name: 'Jigglypuff', type: 'fairy', hp: 50, atk: 6 },
      clefairy: { id: 35, name: 'Clefairy', type: 'fairy', hp: 48, atk: 7 },
      abra: { id: 63, name: 'Abra', type: 'psychic', hp: 25, atk: 8 },
      gastly: { id: 92, name: 'Gastly', type: 'ghost', hp: 30, atk: 12 },
      magikarp: { id: 129, name: 'Magikarp', type: 'water', hp: 20, atk: 2 },
      dratini: { id: 147, name: 'Dratini', type: 'dragon', hp: 41, atk: 10 },
      // Gym Pokemon
      onix: { id: 95, name: 'Onix', type: 'rock', hp: 60, atk: 12 },
      staryu: { id: 120, name: 'Staryu', type: 'water', hp: 55, atk: 10 },
      raichu: { id: 26, name: 'Raichu', type: 'electric', hp: 60, atk: 14 },
      // Elite/Champion Pokemon
      lapras: { id: 131, name: 'Lapras', type: 'water', hp: 70, atk: 12 },
      machamp: { id: 68, name: 'Machamp', type: 'fighting', hp: 65, atk: 16 },
      dragonite: { id: 149, name: 'Dragonite', type: 'dragon', hp: 80, atk: 18 },
      gyarados: { id: 130, name: 'Gyarados', type: 'water', hp: 75, atk: 17 },
      alakazam: { id: 65, name: 'Alakazam', type: 'psychic', hp: 55, atk: 15 },
      gengar: { id: 94, name: 'Gengar', type: 'ghost', hp: 60, atk: 16 },
      // Legendary
      articuno: { id: 144, name: 'Articuno', type: 'ice', hp: 90, atk: 15 },
      zapdos: { id: 145, name: 'Zapdos', type: 'electric', hp: 90, atk: 16 },
      moltres: { id: 146, name: 'Moltres', type: 'fire', hp: 90, atk: 17 },
      mewtwo: { id: 150, name: 'Mewtwo', type: 'psychic', hp: 100, atk: 20 },
      mew: { id: 151, name: 'Mew', type: 'psychic', hp: 100, atk: 18 }
    };

    const TYPE_COLORS = {
      grass: '#78C850', fire: '#F08030', water: '#6890F0', electric: '#F8D030',
      normal: '#A8A878', flying: '#A890F0', bug: '#A8B820', rock: '#B8A038',
      fairy: '#EE99AC', fighting: '#C03028', psychic: '#F85888', ghost: '#705898',
      dragon: '#7038F8', ice: '#98D8D8'
    };

    // ============================================
    // LEVEL CONFIGURATIONS
    // ============================================

    const LEVELS = {
      'trainer-school': {
        name: 'Trainer School',
        storageKey: 'pokemon-trainer-school',
        chapters: [
          { id: 1, name: 'Lesson 1', title: 'üìö Lesson 1 - First Steps', desc: 'Learn to add small numbers!', env: 'env-route', enemies: ['caterpie', 'rattata', 'pidgey'], difficulty: 1, questionsToWin: 3 },
          { id: 2, name: 'Lesson 2', title: 'üå≥ Lesson 2 - Practice', desc: 'More addition practice!', env: 'env-route', enemies: ['weedle', 'oddish', 'pikachu'], difficulty: 1, questionsToWin: 4 },
          { id: 3, name: 'Graduation', title: 'üéì Graduation Day', desc: 'Show what you learned!', env: 'env-gym', enemies: ['eevee', 'jigglypuff', 'clefairy'], difficulty: 1, questionsToWin: 5, isGym: true, badge: 'üìú' }
        ],
        generateQuestion: (difficulty) => {
          const a = Math.floor(Math.random() * 6) + 1;
          const b = Math.floor(Math.random() * 5) + 1;
          const answer = a + b;
          const wrong = answer + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 2) + 1);
          return {
            question: `${a} + ${b} = ?`,
            answer,
            choices: Math.random() > 0.5 ? [answer, wrong] : [wrong, answer]
          };
        }
      },

      'pokemon-league': {
        name: 'Pokemon League',
        storageKey: 'pokemon-league-save',
        chapters: [
          { id: 1, name: 'Route 1', title: 'üå≥ Route 1 - First Steps', desc: 'Your Pokemon journey begins! Practice addition.', env: 'env-route', enemies: ['rattata', 'pidgey', 'caterpie'], difficulty: 1, questionsToWin: 4 },
          { id: 2, name: 'Route 1 Deep', title: 'üå≤ Route 1 - Deeper', desc: 'More Pokemon! Bigger numbers.', env: 'env-route', enemies: ['pidgey', 'weedle', 'rattata'], difficulty: 1, questionsToWin: 4 },
          { id: 3, name: 'Pewter Gym', title: 'üèõÔ∏è Pewter Gym - Brock', desc: 'Your first gym battle!', env: 'env-gym', enemies: ['onix'], difficulty: 2, questionsToWin: 5, isGym: true, gymLeader: 'brock', badge: 'ü™®' },
          { id: 4, name: 'Route 2', title: 'üåä Route 2 - Waterside', desc: 'Addition and subtraction ahead!', env: 'env-water', enemies: ['psyduck', 'oddish', 'pikachu'], difficulty: 2, questionsToWin: 4 },
          { id: 5, name: 'Mt. Moon', title: 'ü¶á Mt. Moon', desc: 'A cave with rare Pokemon!', env: 'env-cave', enemies: ['zubat', 'geodude', 'machop'], difficulty: 2, questionsToWin: 5 },
          { id: 6, name: 'Cerulean Gym', title: 'üíß Cerulean Gym - Misty', desc: 'Water gym! Subtraction challenge!', env: 'env-gym', enemies: ['staryu'], difficulty: 2, questionsToWin: 5, isGym: true, gymLeader: 'misty', badge: 'üíß' },
          { id: 7, name: 'Route 3', title: '‚ú® Route 3 - Rare Pokemon', desc: 'Find missing numbers!', env: 'env-route', enemies: ['eevee', 'jigglypuff', 'clefairy', 'abra'], difficulty: 3, questionsToWin: 5 },
          { id: 8, name: 'Pokemon Tower', title: 'üëª Pokemon Tower', desc: 'Ghost Pokemon! Master all math!', env: 'env-cave', enemies: ['gastly', 'dratini', 'magikarp'], difficulty: 3, questionsToWin: 5 },
          { id: 9, name: 'Vermilion Gym', title: '‚ö° Vermilion Gym - Lt. Surge', desc: 'The final gym!', env: 'env-electric', enemies: ['raichu'], difficulty: 3, questionsToWin: 6, isGym: true, gymLeader: 'surge', badge: '‚ö°' }
        ],
        generateQuestion: (difficulty) => {
          const types = difficulty === 1 ? ['add'] : difficulty === 2 ? ['add', 'sub'] : ['add', 'sub', 'missing'];
          const type = types[Math.floor(Math.random() * types.length)];
          const max = difficulty === 1 ? 10 : difficulty === 2 ? 15 : 25;

          if (type === 'add') {
            const a = Math.floor(Math.random() * max) + 1;
            const b = Math.floor(Math.random() * (max - a)) + 1;
            const answer = a + b;
            return { question: `${a} + ${b} = ?`, answer, choices: generateChoices(answer, 4) };
          } else if (type === 'sub') {
            const answer = Math.floor(Math.random() * max) + 1;
            const b = Math.floor(Math.random() * answer) + 1;
            const a = answer + b;
            return { question: `${a} - ${b} = ?`, answer, choices: generateChoices(answer, 4) };
          } else {
            const a = Math.floor(Math.random() * max) + 1;
            const b = Math.floor(Math.random() * max) + 1;
            const sum = a + b;
            if (Math.random() > 0.5) {
              return { question: `${a} + ? = ${sum}`, answer: b, choices: generateChoices(b, 4) };
            } else {
              return { question: `? + ${b} = ${sum}`, answer: a, choices: generateChoices(a, 4) };
            }
          }
        }
      },

      'champions-road': {
        name: "Champion's Road",
        storageKey: 'pokemon-champions-road',
        chapters: [
          { id: 1, name: 'Training Grounds', title: 'üèãÔ∏è Training Grounds', desc: 'Warm up with larger numbers!', env: 'env-route', enemies: ['machop', 'geodude', 'pikachu'], difficulty: 1, questionsToWin: 4 },
          { id: 2, name: 'Math Dojo', title: 'ü•ã Math Dojo', desc: 'Learn the 2s and 5s times tables!', env: 'env-gym', enemies: ['machop', 'meowth', 'psyduck'], difficulty: 2, questionsToWin: 5 },
          { id: 3, name: 'Victory Road', title: 'üõ§Ô∏è Victory Road', desc: 'Mixed operations ahead!', env: 'env-cave', enemies: ['zubat', 'geodude', 'gastly'], difficulty: 2, questionsToWin: 5 },
          { id: 4, name: 'Elite Lorelei', title: '‚ùÑÔ∏è Elite Four - Lorelei', desc: 'Ice-type trainer! Division challenge!', env: 'env-elite', enemies: ['lapras'], difficulty: 3, questionsToWin: 5, isGym: true, gymLeader: 'lorelei', badge: '‚ùÑÔ∏è' },
          { id: 5, name: 'Word Problems', title: 'üìñ Story Time', desc: 'Solve word problems!', env: 'env-route', enemies: ['alakazam', 'abra', 'eevee'], difficulty: 3, questionsToWin: 5, wordProblems: true },
          { id: 6, name: 'Elite Bruno', title: 'üí™ Elite Four - Bruno', desc: 'Fighting-type trainer!', env: 'env-elite', enemies: ['machamp'], difficulty: 3, questionsToWin: 5, isGym: true, gymLeader: 'bruno', badge: 'üí™' },
          { id: 7, name: 'Legendary Hunt', title: 'üåü Legendary Pokemon', desc: 'Catch legendary Pokemon!', env: 'env-champion', enemies: ['articuno', 'zapdos', 'moltres'], difficulty: 4, questionsToWin: 6 },
          { id: 8, name: 'Champion Lance', title: 'üêâ Champion Lance', desc: 'The final battle!', env: 'env-champion', enemies: ['dragonite'], difficulty: 4, questionsToWin: 6, isGym: true, gymLeader: 'lance', badge: 'üèÜ' }
        ],
        generateQuestion: (difficulty, isWordProblem = false) => {
          if (isWordProblem) {
            return generateWordProblem();
          }

          const operations = difficulty <= 2 ? ['add', 'sub', 'mult2', 'mult5'] :
                            difficulty === 3 ? ['add', 'sub', 'mult', 'div'] :
                            ['add', 'sub', 'mult', 'div', 'mixed'];
          const type = operations[Math.floor(Math.random() * operations.length)];

          if (type === 'add') {
            const a = Math.floor(Math.random() * 50) + 10;
            const b = Math.floor(Math.random() * 50) + 10;
            return { question: `${a} + ${b} = ?`, answer: a + b, choices: generateChoices(a + b, 4) };
          } else if (type === 'sub') {
            const answer = Math.floor(Math.random() * 50) + 10;
            const b = Math.floor(Math.random() * 30) + 5;
            const a = answer + b;
            return { question: `${a} - ${b} = ?`, answer, choices: generateChoices(answer, 4) };
          } else if (type === 'mult2') {
            const b = Math.floor(Math.random() * 10) + 1;
            return { question: `2 x ${b} = ?`, answer: 2 * b, choices: generateChoices(2 * b, 4) };
          } else if (type === 'mult5') {
            const b = Math.floor(Math.random() * 10) + 1;
            return { question: `5 x ${b} = ?`, answer: 5 * b, choices: generateChoices(5 * b, 4) };
          } else if (type === 'mult') {
            const a = Math.floor(Math.random() * 5) + 2;
            const b = Math.floor(Math.random() * 10) + 1;
            return { question: `${a} x ${b} = ?`, answer: a * b, choices: generateChoices(a * b, 4) };
          } else if (type === 'div') {
            const b = Math.floor(Math.random() * 5) + 2;
            const answer = Math.floor(Math.random() * 10) + 1;
            const a = b * answer;
            return { question: `${a} √∑ ${b} = ?`, answer, choices: generateChoices(answer, 4) };
          } else {
            // Mixed two-step
            const a = Math.floor(Math.random() * 20) + 5;
            const b = Math.floor(Math.random() * 10) + 2;
            const c = Math.floor(Math.random() * 10) + 1;
            const answer = a + b * c;
            return { question: `${a} + ${b} x ${c} = ?`, answer, choices: generateChoices(answer, 4), hint: 'Multiply first!' };
          }
        }
      }
    };

    // Word problems for Champion's Road
    function generateWordProblem() {
      const problems = [
        { text: "Ash has 12 Pokeballs. He catches 5 Pokemon. How many Pokeballs are left?", answer: 7 },
        { text: "Misty has 3 teams of 4 Pokemon each. How many Pokemon does she have?", answer: 12 },
        { text: "Brock baked 20 cookies. He gave away 8. How many does he have now?", answer: 12 },
        { text: "There are 5 Pikachu. Each knows 2 moves. How many moves in total?", answer: 10 },
        { text: "15 Pokemon are playing. 6 go home. How many are still playing?", answer: 9 },
        { text: "You have 18 berries. You split them equally among 2 Pokemon. How many does each get?", answer: 9 },
        { text: "A trainer walks 25 steps, then 15 more. How many steps total?", answer: 40 },
        { text: "There are 10 Rattata in 2 equal groups. How many in each group?", answer: 5 },
        { text: "Pikachu used Thunderbolt 8 times. Raichu used it 7 times. How many times total?", answer: 15 },
        { text: "You caught 5 Pokemon on Monday and 5 on Tuesday. How many in 2 days?", answer: 10 }
      ];
      const p = problems[Math.floor(Math.random() * problems.length)];
      return { question: p.text, answer: p.answer, choices: generateChoices(p.answer, 4), isWordProblem: true };
    }

    function generateChoices(answer, count) {
      const choices = new Set([answer]);
      while (choices.size < count) {
        const offset = Math.floor(Math.random() * 5) + 1;
        const wrong = answer + (Math.random() > 0.5 ? offset : -offset);
        if (wrong > 0 && wrong !== answer) choices.add(wrong);
      }
      return [...choices].sort(() => Math.random() - 0.5);
    }

    // ============================================
    // GAME STATE
    // ============================================

    let currentLevel = null;
    let gameState = {
      playerName: '',
      trainer: 'ash',
      starter: 'pikachu',
      currentChapter: 0,
      currentQuestion: 0,
      score: 0,
      streak: 0,
      maxStreak: 0,
      collection: [],
      badges: [],
      stars: 0
    };

    // ============================================
    // AUDIO
    // ============================================

    let audioContext = null;

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioContext.state === 'suspended') audioContext.resume();
    }

    document.addEventListener('touchstart', initAudio, { once: true });
    document.addEventListener('click', initAudio, { once: true });

    function playSound(freq, duration, type = 'sine') {
      if (!audioContext) initAudio();
      if (!audioContext) return;
      try {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = freq;
        osc.type = type;
        gain.gain.setValueAtTime(0.3, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        osc.start();
        osc.stop(audioContext.currentTime + duration);
      } catch (e) {}
    }

    function playCorrect() {
      playSound(523, 0.1);
      setTimeout(() => playSound(659, 0.1), 100);
      setTimeout(() => playSound(784, 0.15), 200);
    }

    function playWrong() {
      playSound(200, 0.3, 'sawtooth');
    }

    function playVictory() {
      playSound(440, 0.1);
      setTimeout(() => playSound(554, 0.1), 100);
      setTimeout(() => playSound(659, 0.1), 200);
      setTimeout(() => playSound(880, 0.3), 300);
    }

    // ============================================
    // CONFETTI
    // ============================================

    function createConfetti() {
      const colors = ['#FFCB05', '#3D7DCA', '#FF0000', '#22C55E', '#9333EA'];
      for (let i = 0; i < 30; i++) {
        setTimeout(() => {
          const conf = document.createElement('div');
          conf.className = 'confetti';
          conf.style.left = Math.random() * 100 + '%';
          conf.style.background = colors[Math.floor(Math.random() * colors.length)];
          document.body.appendChild(conf);
          setTimeout(() => conf.remove(), 3000);
        }, i * 50);
      }
    }

    // ============================================
    // STORAGE
    // ============================================

    function saveGame() {
      if (!currentLevel) return;
      const key = LEVELS[currentLevel].storageKey;
      localStorage.setItem(key, JSON.stringify(gameState));
    }

    function loadGame(level) {
      const key = LEVELS[level].storageKey;
      const saved = localStorage.getItem(key);
      if (saved) {
        const data = JSON.parse(saved);
        gameState = { ...gameState, ...data };
        return true;
      }
      return false;
    }

    function resetGame() {
      if (confirm('Reset all progress for this level?')) {
        const key = LEVELS[currentLevel].storageKey;
        localStorage.removeItem(key);
        gameState = {
          playerName: '',
          trainer: 'ash',
          starter: 'pikachu',
          currentChapter: 0,
          currentQuestion: 0,
          score: 0,
          streak: 0,
          maxStreak: 0,
          collection: [],
          badges: [],
          stars: 0
        };
        showScreen('setupScreen');
        renderSetupScreen();
      }
    }

    // ============================================
    // SCREEN MANAGEMENT
    // ============================================

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function updateLevelProgress() {
      // Trainer School
      const ts = localStorage.getItem(LEVELS['trainer-school'].storageKey);
      const tsDiv = document.getElementById('trainerSchoolProgress');
      if (ts) {
        const data = JSON.parse(ts);
        tsDiv.innerHTML = `<span class="stars">${'‚≠ê'.repeat(data.badges?.length || 0)}</span> ${data.collection?.length || 0} Pokemon caught`;
      } else {
        tsDiv.innerHTML = 'New Adventure!';
      }

      // Pokemon League
      const pl = localStorage.getItem(LEVELS['pokemon-league'].storageKey);
      const plDiv = document.getElementById('pokemonLeagueProgress');
      if (pl) {
        const data = JSON.parse(pl);
        plDiv.innerHTML = `<span class="stars">${data.badges?.join('') || ''}</span> ${data.collection?.length || 0} Pokemon`;
      } else {
        plDiv.innerHTML = 'New Adventure!';
      }

      // Champion's Road
      const cr = localStorage.getItem(LEVELS['champions-road'].storageKey);
      const crDiv = document.getElementById('championsRoadProgress');
      if (cr) {
        const data = JSON.parse(cr);
        crDiv.innerHTML = `<span class="stars">${data.badges?.join('') || ''}</span> ${data.collection?.length || 0} Pokemon`;
      } else {
        crDiv.innerHTML = 'New Challenge!';
      }
    }

    function selectLevel(level) {
      currentLevel = level;
      gameState = {
        playerName: '',
        trainer: 'ash',
        starter: 'pikachu',
        currentChapter: 0,
        currentQuestion: 0,
        score: 0,
        streak: 0,
        maxStreak: 0,
        collection: [],
        badges: [],
        stars: 0
      };

      if (loadGame(level)) {
        if (gameState.playerName) {
          showScreen('chapterScreen');
          renderChapterScreen();
          return;
        }
      }

      showScreen('setupScreen');
      renderSetupScreen();
    }

    function backToWorld() {
      currentLevel = null;
      showScreen('worldSelectScreen');
      updateLevelProgress();
    }

    // ============================================
    // SETUP SCREEN
    // ============================================

    function renderSetupScreen() {
      const level = LEVELS[currentLevel];
      const trainerHTML = Object.entries(TRAINERS).map(([key, t]) => `
        <div class="trainer-card ${gameState.trainer === key ? 'selected' : ''}" onclick="selectTrainer('${key}')">
          <img src="${t.sprite}" alt="${t.name}">
          <div class="name">${t.name}</div>
        </div>
      `).join('');

      const starters = ['bulbasaur', 'charmander', 'squirtle'];
      const starterHTML = starters.map(key => {
        const p = POKEMON[key];
        return `
          <div class="starter-card ${gameState.starter === key ? 'selected' : ''}" onclick="selectStarter('${key}')">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.id}.png" alt="${p.name}">
            <div class="name">${p.name}</div>
            <span class="type-badge" style="background: ${TYPE_COLORS[p.type]}">${p.type}</span>
          </div>
        `;
      }).join('');

      document.getElementById('setupScreen').innerHTML = `
        <div class="start-screen">
          <div class="logo">${level.name}</div>
          <div class="subtitle">Set up your trainer!</div>

          <div class="card">
            <div class="name-input-section">
              <label>Your Name</label>
              <input type="text" class="name-input" id="playerNameInput" placeholder="Enter your name" value="${gameState.playerName}" maxlength="12">
            </div>
          </div>

          <div class="card">
            <label style="display:block;color:#374151;font-weight:700;margin-bottom:10px;">Choose Your Trainer</label>
            <div class="trainer-grid">${trainerHTML}</div>
          </div>

          <div class="card">
            <label style="display:block;color:#374151;font-weight:700;margin-bottom:10px;">Choose Your Starter</label>
            <div class="starter-grid">${starterHTML}</div>
          </div>

          <button class="btn btn-warning start-btn" onclick="startGame()">START ADVENTURE!</button>
          <button class="btn back-btn" onclick="backToWorld()">‚Üê Back</button>
        </div>
      `;
    }

    function selectTrainer(key) {
      gameState.trainer = key;
      renderSetupScreen();
    }

    function selectStarter(key) {
      gameState.starter = key;
      renderSetupScreen();
    }

    function startGame() {
      const nameInput = document.getElementById('playerNameInput');
      gameState.playerName = nameInput.value.trim() || 'Trainer';
      if (!gameState.collection.includes(gameState.starter)) {
        gameState.collection.push(gameState.starter);
      }
      saveGame();
      showScreen('chapterScreen');
      renderChapterScreen();
    }

    // ============================================
    // CHAPTER SCREEN
    // ============================================

    function renderChapterScreen() {
      const level = LEVELS[currentLevel];
      const chapter = level.chapters[gameState.currentChapter];
      const trainer = TRAINERS[gameState.trainer];

      document.getElementById('chapterScreen').innerHTML = `
        <div class="chapter-screen">
          <div class="game-header">
            <div class="header-left">
              <div class="trainer-avatar"><img src="${trainer.sprite}" alt="${trainer.name}"></div>
              <div class="player-info">
                <div class="player-name">${gameState.playerName}</div>
                <div class="badges">${gameState.badges.join('') || 'No badges'}</div>
              </div>
            </div>
            <div class="header-stats">
              <div class="stat">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value">${gameState.stars}</div>
                <div class="stat-label">Stars</div>
              </div>
              <div class="stat">
                <div class="stat-icon">üéí</div>
                <div class="stat-value">${gameState.collection.length}</div>
                <div class="stat-label">Pokemon</div>
              </div>
            </div>
          </div>

          <div class="chapter-banner ${chapter.env}">
            <div class="chapter-title">${chapter.title}</div>
            <div class="chapter-desc">${chapter.desc}</div>
          </div>

          <div class="card" style="text-align:center;">
            <p style="margin-bottom:15px;color:#6B7280;">Answer ${chapter.questionsToWin} questions to complete this chapter!</p>
            <button class="btn btn-success continue-btn" onclick="startBattle()">BEGIN!</button>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;">
            <button class="btn back-btn" style="flex:1;" onclick="backToWorld()">‚Üê World Map</button>
            <button class="btn back-btn" style="flex:1;background:#EF4444;box-shadow:0 4px 0 #B91C1C;" onclick="resetGame()">Reset</button>
          </div>
        </div>
      `;
    }

    // ============================================
    // BATTLE SCREEN
    // ============================================

    let currentEnemy = null;
    let currentQuestionData = null;
    let questionsAnswered = 0;
    let enemyHP = 100;

    function startBattle() {
      const level = LEVELS[currentLevel];
      const chapter = level.chapters[gameState.currentChapter];
      const enemyKey = chapter.enemies[Math.floor(Math.random() * chapter.enemies.length)];
      currentEnemy = { key: enemyKey, ...POKEMON[enemyKey] };
      questionsAnswered = 0;
      enemyHP = 100;
      showScreen('gameScreen');
      renderBattle();
    }

    function renderBattle() {
      const level = LEVELS[currentLevel];
      const chapter = level.chapters[gameState.currentChapter];
      const trainer = TRAINERS[gameState.trainer];

      // Generate question
      currentQuestionData = level.generateQuestion(chapter.difficulty, chapter.wordProblems);

      const choicesHTML = currentQuestionData.choices.map(c => `
        <button class="answer-btn" onclick="submitAnswer(${c})">${c}</button>
      `).join('');

      const questionHTML = currentQuestionData.isWordProblem
        ? `<div class="word-problem">${currentQuestionData.question}</div>`
        : `<div class="question">${currentQuestionData.question}</div>`;

      const hpPercent = enemyHP;
      const hpClass = hpPercent > 50 ? '' : hpPercent > 20 ? 'medium' : 'low';

      document.getElementById('gameScreen').innerHTML = `
        <div class="chapter-screen">
          <div class="game-header">
            <div class="header-left">
              <div class="trainer-avatar"><img src="${trainer.sprite}"></div>
              <div class="player-info">
                <div class="player-name">${gameState.playerName}</div>
                <div class="badges">${gameState.badges.join('') || ''}</div>
              </div>
            </div>
            <div class="header-stats">
              <div class="stat">
                <div class="stat-icon">üî•</div>
                <div class="stat-value">${gameState.streak}</div>
                <div class="stat-label">Streak</div>
              </div>
              <div class="stat">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value">${gameState.stars}</div>
                <div class="stat-label">Stars</div>
              </div>
            </div>
          </div>

          <div class="battle-area">
            <div class="pokemon-display">
              <div class="wild-pokemon">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${currentEnemy.id}.png" alt="${currentEnemy.name}">
                <div class="pokemon-name">${currentEnemy.name}</div>
                <div class="hp-bar"><div class="hp-fill ${hpClass}" style="width:${hpPercent}%"></div></div>
              </div>
            </div>
          </div>

          <div class="question-area">
            <div class="question-prompt">${chapter.isGym ? '‚öîÔ∏è Gym Battle!' : 'üéØ Answer to attack!'} (${questionsAnswered + 1}/${chapter.questionsToWin})</div>
            ${questionHTML}
            ${currentQuestionData.hint ? `<div style="text-align:center;color:#F59E0B;font-size:0.9rem;margin-bottom:10px;">üí° ${currentQuestionData.hint}</div>` : ''}
            <div class="answers ${currentQuestionData.choices.length === 3 ? 'three-cols' : ''}">${choicesHTML}</div>
            <div class="message" id="feedbackMessage"></div>
          </div>
        </div>
      `;
    }

    function submitAnswer(answer) {
      const level = LEVELS[currentLevel];
      const chapter = level.chapters[gameState.currentChapter];
      const isCorrect = answer === currentQuestionData.answer;
      const feedbackEl = document.getElementById('feedbackMessage');
      const buttons = document.querySelectorAll('.answer-btn');

      buttons.forEach(btn => {
        btn.disabled = true;
        if (parseInt(btn.textContent) === currentQuestionData.answer) {
          btn.classList.add('correct');
        } else if (parseInt(btn.textContent) === answer && !isCorrect) {
          btn.classList.add('wrong');
        }
      });

      if (isCorrect) {
        playCorrect();
        gameState.streak++;
        gameState.maxStreak = Math.max(gameState.maxStreak, gameState.streak);
        gameState.stars += 1 + (gameState.streak >= 3 ? 1 : 0);
        questionsAnswered++;
        enemyHP -= Math.ceil(100 / chapter.questionsToWin);
        if (enemyHP < 0) enemyHP = 0;

        const messages = ["Super effective! üí•", "Critical hit! ‚ö°", "Amazing! üåü", "Great job! ‚ú®"];
        feedbackEl.className = 'message success';
        feedbackEl.textContent = messages[Math.floor(Math.random() * messages.length)];

        setTimeout(() => {
          if (questionsAnswered >= chapter.questionsToWin) {
            showCatchScreen();
          } else {
            renderBattle();
          }
        }, 1000);
      } else {
        playWrong();
        gameState.streak = 0;

        const messages = ["Try again! üí™", "You can do it! üåü", "Keep going! üéØ"];
        feedbackEl.className = 'message encouragement';
        feedbackEl.textContent = messages[Math.floor(Math.random() * messages.length)];

        setTimeout(() => renderBattle(), 1500);
      }

      saveGame();
    }

    // ============================================
    // CATCH SCREEN
    // ============================================

    function showCatchScreen() {
      const alreadyHave = gameState.collection.includes(currentEnemy.key);

      document.getElementById('catchScreen').innerHTML = `
        <div class="catch-screen">
          <div class="catch-animation" id="catchAnim">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="pokeball">
          </div>
          <div class="caught-pokemon" id="caughtPokemon">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${currentEnemy.id}.png" alt="${currentEnemy.name}">
          </div>
          <div class="catch-message" id="catchMsg">Catching...</div>
          <div class="card" style="margin-top:20px;">
            <div class="stat-row"><span>Pokemon</span><span>${currentEnemy.name}</span></div>
            <div class="stat-row"><span>Type</span><span style="color:${TYPE_COLORS[currentEnemy.type]}">${currentEnemy.type}</span></div>
            <div class="stat-row"><span>Streak</span><span>üî• ${gameState.streak}</span></div>
          </div>
          <button class="btn btn-success continue-btn hidden" id="continueBtn" onclick="afterCatch()">Continue ‚Üí</button>
        </div>
      `;

      showScreen('catchScreen');

      setTimeout(() => {
        document.getElementById('catchAnim').classList.add('hidden');
        document.getElementById('caughtPokemon').classList.add('show');
        document.getElementById('catchMsg').textContent = alreadyHave ? `${currentEnemy.name} stayed with you!` : `Caught ${currentEnemy.name}!`;
        document.getElementById('continueBtn').classList.remove('hidden');

        if (!alreadyHave) {
          gameState.collection.push(currentEnemy.key);
          createConfetti();
        }
        playVictory();
        saveGame();
      }, 2000);
    }

    function afterCatch() {
      const level = LEVELS[currentLevel];
      const chapter = level.chapters[gameState.currentChapter];

      if (chapter.isGym && chapter.badge && !gameState.badges.includes(chapter.badge)) {
        gameState.badges.push(chapter.badge);
        saveGame();
      }

      gameState.currentChapter++;

      if (gameState.currentChapter >= level.chapters.length) {
        showVictoryScreen();
      } else {
        showScreen('chapterScreen');
        renderChapterScreen();
      }
    }

    // ============================================
    // VICTORY SCREEN
    // ============================================

    function showVictoryScreen() {
      const level = LEVELS[currentLevel];
      createConfetti();
      setTimeout(createConfetti, 500);
      playVictory();

      document.getElementById('victoryScreen').innerHTML = `
        <div class="victory-screen">
          <div class="victory-title">üéâ ${level.name} Complete! üéâ</div>
          <div class="badge-earned">${gameState.badges.join(' ')}</div>
          <div class="card">
            <h3 style="color:#374151;margin-bottom:15px;">Your Journey</h3>
            <div class="stat-row"><span>Pokemon Caught</span><span>${gameState.collection.length}</span></div>
            <div class="stat-row"><span>Stars Earned</span><span>‚≠ê ${gameState.stars}</span></div>
            <div class="stat-row"><span>Best Streak</span><span>üî• ${gameState.maxStreak}</span></div>
            <div class="stat-row"><span>Badges</span><span>${gameState.badges.join(' ') || 'None'}</span></div>
          </div>
          <button class="btn btn-warning continue-btn" onclick="backToWorld()">Back to World Map</button>
        </div>
      `;

      showScreen('victoryScreen');
    }

    // ============================================
    // INIT
    // ============================================

    // Fix iOS 100vh
    function setVH() {
      document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    }
    setVH();
    window.addEventListener('resize', setVH);

    // Initialize
    updateLevelProgress();
  </script>
</body>
</html>
